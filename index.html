<!DOCTYPE html>
<html lang="en"> 
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weather & TrishaBot</title>
  <style>
    /* Simple styling so chat container is visible */
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 20px; }
    .container { max-width: 400px; margin: auto; }
    .weather-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    #chatBtn { position: fixed; bottom: 20px; right: 20px; font-size: 24px; cursor: pointer; }
    #chatContainer { position: fixed; bottom: 70px; right: 20px; width: 350px; max-height: 400px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
    #chatContainer.hidden { display: none; }
    .chat-header { background: #007bff; color: white; padding: 10px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { padding: 10px; overflow-y: auto; flex-grow: 1; }
    .chat-input { display: flex; border-top: 1px solid #ccc; }
    .chat-input input { flex-grow: 1; padding: 10px; border: none; border-radius: 0 0 0 8px; }
    .chat-input button { background: #007bff; color: white; border: none; padding: 0 20px; cursor: pointer; border-radius: 0 0 8px 0; }
    .user-msg { text-align: right; margin: 5px 0; color: #007bff; }
    .bot-msg { text-align: left; margin: 5px 0; color: #333; }
    .typing { font-style: italic; color: gray; margin: 5px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="weather-card" id="weatherCard">
      <h2>Loading Weather... â˜ï¸</h2>
    </div>
  </div>

  <!-- Chat Button -->
  <button id="chatBtn" aria-label="Open chat">ğŸ’¬</button>

  <!-- Chatbot Window -->
  <div id="chatContainer" class="hidden" role="dialog" aria-modal="true" aria-labelledby="chatTitle">
    <div class="chat-header">
      <div>
        <h3 id="chatTitle">WeatherBot ğŸ¤–</h3>
        <small>Your friendly AI assistant</small>
      </div>
      <button id="closeChat" aria-label="Close chat">âœ–ï¸</button>
    </div>
    <div class="chat-messages" id="chatMessages" tabindex="0" aria-live="polite"></div>
    <form id="chatForm" class="chat-input" autocomplete="off">
      <input type="text" id="userInput" placeholder="Ask me anything..." required aria-label="Chat input" />
      <button type="submit" id="sendBtn">Send</button>
    </form>
  </div>

<script>
let currentTemp = null; // store temperature

const weatherCard = document.getElementById("weatherCard");

function getWeatherEmoji(desc) {
  desc = desc.toLowerCase();
  if (desc.includes("rain")) return "ğŸŒ§ï¸";
  if (desc.includes("cloud")) return "â˜ï¸";
  if (desc.includes("clear")) return "â˜€ï¸";
  if (desc.includes("storm")) return "â›ˆï¸";
  if (desc.includes("snow")) return "â„ï¸";
  return "ğŸŒ¡ï¸";
}

function displayWeather(data) {
  currentTemp = data.main.temp;
  const city = data.name;
  const desc = data.weather[0].description;
  const emoji = getWeatherEmoji(desc);

  weatherCard.innerHTML = `
    <h2>${emoji} ${Math.round(currentTemp)}Â°C - ${desc}</h2>
    <p>ğŸ“ ${city}</p>
  `;
}

function fetchWeather(lat, lon) {
  const apiKey = "d5efe77663327fbbf221e7ef326cd3a5";
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`;
  fetch(url)
    .then(res => res.json())
    .then(data => displayWeather(data))
    .catch(() => {
      weatherCard.innerHTML = "<h2>Failed to fetch weather ğŸ˜</h2>";
    });
}

navigator.geolocation.getCurrentPosition(
  position => {
    fetchWeather(position.coords.latitude, position.coords.longitude);
  },
  () => {
    weatherCard.innerHTML = "<h2>Location access denied ğŸ˜</h2>";
  }
);

// --- CHATBOT SECTION ---
const chatBtn = document.getElementById("chatBtn");
const chatContainer = document.getElementById("chatContainer");
const closeChat = document.getElementById("closeChat");
const chatForm = document.getElementById("chatForm");
const userInput = document.getElementById("userInput");
const chatMessages = document.getElementById("chatMessages");

chatBtn.onclick = () => chatContainer.classList.remove("hidden");
closeChat.onclick = () => chatContainer.classList.add("hidden");

chatForm.onsubmit = async (e) => {
  e.preventDefault();
  const msg = userInput.value.trim();
  if (!msg) return;

  console.log("ğŸŸ¢ User message sent:", msg);
  console.log("ğŸŒ¡ï¸ Current temperature:", currentTemp);

  addMessage("You", msg, "user-msg");
  userInput.value = "";

  const typingDiv = document.createElement("div");
  typingDiv.classList.add("typing");
  typingDiv.innerText = "TrishaBot is typing...";
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    const promptToSend = `Based on the current temperature ${currentTemp}Â°C, ${msg}`;
    console.log("ğŸ“¨ Prompt to backend:", promptToSend);

    // Change here for Hugging Face backend - endpoint and JSON key "message"
    const response = await fetch("https://ai-powered-weather-app-5i4j.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: promptToSend })
    });

    const data = await response.json();
    console.log("ğŸŸ¡ Response from backend:", data);

    chatMessages.removeChild(typingDiv);
    addMessage("TrishaBot", data.reply || "Iâ€™m not sure what to say ğŸ¤·â€â™€ï¸", "bot-msg");
  } catch (err) {
    console.error("âŒ Error calling backend API:", err);
    chatMessages.removeChild(typingDiv);
    addMessage("TrishaBot", "Something went wrong ğŸ˜¢", "bot-msg");
  }
};

function addMessage(sender, text, className) {
  const msgDiv = document.createElement("div");
  msgDiv.classList.add(className);
  msgDiv.textContent = text;
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>
</body>
</html>
